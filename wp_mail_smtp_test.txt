<?php
/*
Plugin Name: WP-Mail-SMTP-Test
Version: 0.1
Plugin URI: http://www.callum-macdonald.com/code/wp-mail-smtp/
Description: Creates an admin page you can use to send test mails
Author: Callum Macdonald
Author URI: http://www.callum-macdonald.com/
*/

/**
 * If you've enabled WPMS_ON in your wp-config.php file, you lose the ability
 * to send test emails. If you want to do that, rename this file from .txt to
 * .php and then go to plugins and activate it.
 */

// Add the create pages options
add_action('admin_menu','wp_mail_smtp_menus_test');

/**
 * This function adds the required page (only 1 at the moment).
 */
if (!function_exists('wp_mail_smtp_menus_test')) :
function wp_mail_smtp_menus_test() {
	
	if (function_exists('add_submenu_page')) {
		add_options_page(__('Advanced Email Options Test', 'wp_mail_smtp'),__('Email Test', 'wp_mail_smtp'),'manage_options',__FILE__,'wp_mail_smtp_options_page_test');
	}
	
} // End of wp_mail_smtp_menus() function definition
endif;


/**
 * This function outputs the plugin options page.
 */
if (!function_exists('wp_mail_smtp_options_page_test')) :
// Define the function
function wp_mail_smtp_options_page_test() {
	
	// Load the options
	global $wpms_options, $phpmailer;
	
	// Make sure the PHPMailer class has been instantiated 
	// (copied verbatim from wp-includes/pluggable.php)
	// (Re)create it, if it's gone missing
	if ( !is_object( $phpmailer ) || !is_a( $phpmailer, 'PHPMailer' ) ) {
		require_once ABSPATH . WPINC . '/class-phpmailer.php';
		require_once ABSPATH . WPINC . '/class-smtp.php';
		$phpmailer = new PHPMailer();
	}

	// Send a test mail if necessary
	if (isset($_POST['wpms_action']) && $_POST['wpms_action'] == __('Send Test', 'wp_mail_smtp') && isset($_POST['to'])) {
		
		// Set up the mail variables
		$to = $_POST['to'];
		$subject = 'WP Mail SMTP: ' . __('Test mail to ', 'wp_mail_smtp') . $to;
		$message = __('This is a test email generated by the WP Mail SMTP WordPress plugin.', 'wp_mail_smtp');
		
		// Set SMTPDebug to level 2
		$phpmailer->SMTPDebug = 2;
		
		// Start output buffering to grab smtp debugging output
		ob_start();

		// Send the test mail
		$result = wp_mail($to,$subject,$message);
		
		// Grab the smtp debugging output
		$smtp_debug = ob_get_clean();
		
		// Output the response
		?>
<div id="message" class="updated fade"><p><strong><?php _e('Test Message Sent', 'wp_mail_smtp'); ?></strong></p>
<p><?php _e('The result was:', 'wp_mail_smtp'); ?></p>
<pre><?php var_dump($result); ?></pre>
<?php //if ($result != true) { ?>
<p><?php _e('The full debugging output is shown below:', 'wp_mail_smtp'); ?></p>
<pre><?php var_dump($phpmailer); ?></pre>
<?php //} ?>
<p><?php _e('The SMTP debugging output is shown below:', 'wp_mail_smtp'); ?></p>
<pre><?php echo $smtp_debug ?></pre>
</div>
		<?php

	}
	
	?>
<div class="wrap">
<h2><?php _e('Advanced Email Options', 'wp_mail_smtp'); ?></h2>

<form method="POST">
<fieldset class="options">
<legend><?php _e('Send a Test Email', 'wp_mail_smtp'); ?></legend>
<table class="optiontable">
<tr valign="top">
<th scope="row"><?php _e('To:', 'wp_mail_smtp'); ?> </th>
<td><p><input name="to" type="text" id="to" value="" size="40" class="code" /><br />
<?php _e('Type an email address here and then click Send Test to generate a test email.', 'wp_mail_smtp'); ?></p></td>
</tr>
</table>
<p class="submit"><input type="submit" name="wpms_action" value="<?php _e('Send Test', 'wp_mail_smtp'); ?>" /></p>
</fieldset>
</form>

</div>
	<?php
	
} // End of wp_mail_smtp_options_page_test() function definition
endif;



?>
